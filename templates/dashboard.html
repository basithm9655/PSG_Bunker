{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Stats -->
    <div class="stats-grid">
        <div class="stat-card glass-card">
            <div class="stat-icon safe">
                <i class="fas fa-book"></i>
            </div>
            <div class="stat-info">
                <h3>{{ overall_stats.total_courses }}</h3>
                <p>Total Courses</p>
            </div>
        </div>
        
        <div class="stat-card glass-card">
            <div class="stat-icon info">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-info">
                <h3>{{ overall_stats.average_attendance }}%</h3>
                <p>Average Attendance</p>
            </div>
        </div>
        
        <div class="stat-card glass-card">
            <div class="stat-icon safe">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ overall_stats.safe_courses }}</h3>
                <p>Safe Courses</p>
            </div>
        </div>
        
        <div class="stat-card glass-card">
            <div class="stat-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ overall_stats.warning_courses }}</h3>
                <p>Warning Courses</p>
            </div>
        </div>
        
        <div class="stat-card glass-card">
            <div class="stat-icon danger">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ overall_stats.danger_courses }}</h3>
                <p>Danger Courses</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="action-btn glass-card" onclick="location.href='{{ url_for('timetable') }}'">
            <i class="fas fa-calendar-alt"></i>
            <span>View Timetable</span>
        </button>
        <button class="action-btn glass-card" onclick="showBunkPlanner()">
            <i class="fas fa-calculator"></i>
            <span>Bunk Planner</span>
        </button>
        <button class="action-btn glass-card" onclick="showManualEntry()">
            <i class="fas fa-edit"></i>
            <span>Manual Entry</span>
        </button>
        <button class="action-btn glass-card" onclick="clearManualData()">
            <i class="fas fa-trash"></i>
            <span>Clear Manual Data</span>
        </button>
    </div>

    <!-- Attendance Table -->
    <div class="attendance-section">
        <div class="section-header">
            <h2><i class="fas fa-chart-bar"></i> Course Attendance</h2>
            <div class="last-updated">
                {% if attendance_data %}
                Last updated: {{ attendance_data[0].attendance_to if attendance_data else 'N/A' }}
                {% endif %}
            </div>
        </div>

        {% if message and not attendance_data %}
        <div class="empty-state glass-card">
            <i class="fas fa-exclamation-circle"></i>
            <h3>No Attendance Data</h3>
            <p>{{ message }}</p>
            <button class="btn-secondary" onclick="location.reload()">
                <i class="fas fa-redo"></i> Refresh
            </button>
        </div>
        {% elif attendance_data %}
        <div class="table-container glass-card">
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>Course Code</th>
                        <th>Total Hours</th>
                        <th>Present</th>
                        <th>Percentage</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in attendance_data %}
                    <tr class="attendance-row {{ 'safe' if course.percentage >= (session.threshold|default(75) + 5) else 'warning' if course.percentage >= session.threshold|default(75) else 'danger' }}">
                        <td>
                            <strong>{{ course.course_code }}</strong>
                        </td>
                        <td>{{ course.total_hours }}</td>
                        <td>{{ course.total_present }}</td>
                        <td>
                            <div class="percentage-bar">
                                <div class="percentage-text">{{ course.percentage }}%</div>
                                <div class="bar-container">
                                    <div class="bar-fill" style="width: {{ course.percentage }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge {{ 'safe' if course.percentage >= (session.threshold|default(75) + 5) else 'warning' if course.percentage >= session.threshold|default(75) else 'danger' }}">
                                {% if course.percentage >= (session.threshold|default(75) + 5) %}
                                Safe
                                {% elif course.percentage >= session.threshold|default(75) %}
                                Warning
                                {% else %}
                                Danger
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if course.action == 'attend' %}
                            <span class="action-attend">
                                <i class="fas fa-user-plus"></i> Attend {{ course.classes_to_attend }} classes
                            </span>
                            {% else %}
                            <span class="action-bunk">
                                <i class="fas fa-user-slash"></i> Bunk {{ course.classes_to_bunk }} classes
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- Bunk Planner Modal -->
<div id="bunkPlannerModal" class="modal-overlay">
    <div class="modal-content glass-card">
        <div class="modal-header">
            <h3><i class="fas fa-calculator"></i> Bunk Planner</h3>
            <button class="close-btn" onclick="closeModal('bunkPlannerModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Select Course</label>
                <select id="plannerCourse" class="form-select">
                    {% for course in attendance_data %}
                    <option value="{{ course.course_code }}">{{ course.course_code }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Number of Classes to Bunk</label>
                <input type="number" id="plannedBunks" class="form-input" min="0" value="1">
            </div>
            <div id="plannerResult" class="planner-result"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('bunkPlannerModal')">Cancel</button>
            <button class="btn-primary" onclick="calculateBunkImpact()">Calculate Impact</button>
        </div>
    </div>
</div>

<!-- Manual Entry Modal -->
<div id="manualEntryModal" class="modal-overlay">
    <div class="modal-content glass-card">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Manual Attendance Entry</h3>
            <button class="close-btn" onclick="closeModal('manualEntryModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Select Course</label>
                <select id="manualCourse" class="form-select">
                    {% for course in attendance_data %}
                    <option value="{{ course.course_code }}">{{ course.course_code }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Additional Hours</label>
                <input type="number" id="additionalHours" class="form-input" min="0" value="0">
            </div>
            <div class="form-group">
                <label>Additional Present</label>
                <input type="number" id="additionalPresent" class="form-input" min="0" value="0">
            </div>
            <div class="form-note">
                <i class="fas fa-info-circle"></i>
                This data will be added to your current attendance and cleared when college updates
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('manualEntryModal')">Cancel</button>
            <button class="btn-primary" onclick="saveManualEntry()">Save Entry</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/attendance.js') }}"></script>
{% endblock %}
